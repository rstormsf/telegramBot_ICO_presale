var Tx = require('ethereumjs-tx');
const { web3 } = require('../w3');
var abi = require('../../contracts/abi/deal.json');
const { getFundAddress, getFundPrivateKey } = require('../database/fund');

async function deployDealContract(username) {
  const fundPrivateKey = await getFundPrivateKey(username);
  const fundAddress = await getFundAddress(username);
  let contract = new web3.eth.Contract(abi);
  let instance = await contract.deploy({data: '0x60606040526000600460006101000a81548160ff021916908315150217905550341561002a57600080fd5b33600660006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555061051c8061007a6000396000f3006060604052600436106100a4576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff1680632c4e722e146100ae5780633197cbb6146100d7578063355274ea14610100578063392e53cd146101295780634ec81af11461015657806378e97925146101aa5780638da5cb5b146101d3578063a6f2ae3a14610228578063b29a61c114610232578063db068e0e1461027f575b6100ac6102a2565b005b34156100b957600080fd5b6100c1610329565b6040518082815260200191505060405180910390f35b34156100e257600080fd5b6100ea61032f565b6040518082815260200191505060405180910390f35b341561010b57600080fd5b610113610335565b6040518082815260200191505060405180910390f35b341561013457600080fd5b61013c61033b565b604051808215151515815260200191505060405180910390f35b341561016157600080fd5b6101a8600480803573ffffffffffffffffffffffffffffffffffffffff1690602001909190803590602001909190803590602001909190803590602001909190505061034e565b005b34156101b557600080fd5b6101bd6103e1565b6040518082815260200191505060405180910390f35b34156101de57600080fd5b6101e66103e7565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b6102306102a2565b005b341561023d57600080fd5b610269600480803573ffffffffffffffffffffffffffffffffffffffff1690602001909190505061040d565b6040518082815260200191505060405180910390f35b341561028a57600080fd5b6102a06004808035906020019091905050610425565b005b600080341115156102b257600080fd5b600460009054906101000a900460ff1615156102cd57600080fd5b33905034600560008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600082825401925050819055506103263461048b565b50565b60035481565b60015481565b60025481565b600460009054906101000a900460ff1681565b600460009054906101000a900460ff1615151561036a57600080fd5b83600660006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055508260008190555081600181905550806002819055506001600460006101000a81548160ff02191690831515021790555050505050565b60005481565b600660009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b60056020528060005260406000206000915090505481565b600660009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614151561048157600080fd5b8060038190555050565b600660009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166108fc829081150290604051600060405180830381858888f1935050505015156104ed57600080fd5b505600a165627a7a72305820259521608e034b06058e47cd2a4e4fb43d83fd16ff49acc33baac8cd819b86c30029'});
  let gasEstimate = await instance.estimateGas();
  var privateKey = new Buffer(fundPrivateKey, 'hex');
  var txcount = await web3.eth.getTransactionCount(fundAddress);
  var rawTx = {
    nonce: web3.utils.toHex(txcount),
    gasPrice: web3.utils.toHex(1000099000),
    gasLimit: gasEstimate * 3,
    data: '0x60606040526000600460006101000a81548160ff021916908315150217905550341561002a57600080fd5b33600660006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555061051c8061007a6000396000f3006060604052600436106100a4576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff1680632c4e722e146100ae5780633197cbb6146100d7578063355274ea14610100578063392e53cd146101295780634ec81af11461015657806378e97925146101aa5780638da5cb5b146101d3578063a6f2ae3a14610228578063b29a61c114610232578063db068e0e1461027f575b6100ac6102a2565b005b34156100b957600080fd5b6100c1610329565b6040518082815260200191505060405180910390f35b34156100e257600080fd5b6100ea61032f565b6040518082815260200191505060405180910390f35b341561010b57600080fd5b610113610335565b6040518082815260200191505060405180910390f35b341561013457600080fd5b61013c61033b565b604051808215151515815260200191505060405180910390f35b341561016157600080fd5b6101a8600480803573ffffffffffffffffffffffffffffffffffffffff1690602001909190803590602001909190803590602001909190803590602001909190505061034e565b005b34156101b557600080fd5b6101bd6103e1565b6040518082815260200191505060405180910390f35b34156101de57600080fd5b6101e66103e7565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b6102306102a2565b005b341561023d57600080fd5b610269600480803573ffffffffffffffffffffffffffffffffffffffff1690602001909190505061040d565b6040518082815260200191505060405180910390f35b341561028a57600080fd5b6102a06004808035906020019091905050610425565b005b600080341115156102b257600080fd5b600460009054906101000a900460ff1615156102cd57600080fd5b33905034600560008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600082825401925050819055506103263461048b565b50565b60035481565b60015481565b60025481565b600460009054906101000a900460ff1681565b600460009054906101000a900460ff1615151561036a57600080fd5b83600660006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055508260008190555081600181905550806002819055506001600460006101000a81548160ff02191690831515021790555050505050565b60005481565b600660009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b60056020528060005260406000206000915090505481565b600660009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614151561048157600080fd5b8060038190555050565b600660009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166108fc829081150290604051600060405180830381858888f1935050505015156104ed57600080fd5b505600a165627a7a72305820259521608e034b06058e47cd2a4e4fb43d83fd16ff49acc33baac8cd819b86c30029'
  }
  var tx = new Tx(rawTx);
  tx.sign(privateKey);
  
  var serializedTx = tx.serialize();
  
  receipt = await web3.eth.sendSignedTransaction('0x' + serializedTx.toString('hex'))
  return receipt['contractAddress'];
}

module.exports = deployDealContract;
